# dvcfl
A tool for getting the driver device file and coressponding ioctl function name.
For dynamic kernel driver analysis, it is important to get all the device files and their corresponding ioctl functions. 
This repo contains a kernel module and a user-space program interact with the kernel module to get ioctl functions.
This is module would leak kernel infomation to user-space, it is important that remove the module if you didn't need it.
## 1. Build the Module
Edit the Makefile and set KERNELDIR to your corresponding kernel build folder. Make sure the kernel build dir contains header 
files that a normal module needs. If the kernel is x86 based, type `cp Makefile.x86 Makefile`. If the kernel is aarch64 based, type 
`cp Makefile.aarch64 Makefile`, Then, just type `make`. Ex: aarch64 based kernel:
```
$ make
aarch64-linux-gnu-gcc -static getdvcfl.c -o getdvcfl
make -C /workspace/difuze/AndroidKernels/huawei/mate9/Code_Opensource/out-hello ARCH=arm64 CROSS_COMPILE=aarch64-linux-android- M=/workspace/difuze/AndroidKernels/ioctldev/dvcfl/dvcfl modules 
make[1]: Entering directory '/workspace/difuze/AndroidKernels/huawei/mate9/Code_Opensource/out-hello'

  WARNING: Symbol version dump /workspace/difuze/AndroidKernels/huawei/mate9/Code_Opensource/out-hello/Module.symvers
           is missing; modules will have no dependencies and modversions.

  CC [M]  /workspace/difuze/AndroidKernels/ioctldev/dvcfl/dvcfl/dvcfl.o
  Building modules, stage 2.
  MODPOST 1 modules
  CC      /workspace/difuze/AndroidKernels/ioctldev/dvcfl/dvcfl/dvcfl.mod.o
  LD [M]  /workspace/difuze/AndroidKernels/ioctldev/dvcfl/dvcfl/dvcfl.ko
make[1]: Leaving directory '/workspace/difuze/AndroidKernels/huawei/mate9/Code_Opensource/out-hello'
$
Firstly, an execute user-space program called getdvcfl is generated by aarch64-linux-gnu-gcc. Then, aarch64-linux-android- tools build the module dvcfl.ko.
```
Ex: x86 based kernel:
```
$ make
make -C /usr/src/linux-headers-`uname -r` ARCH=x86   M=/workspace/difuze/AndroidKernels/ioctldev/dvcfl/dvcfl modules 
make[1]: Entering directory '/usr/src/linux-headers-4.13.0-43-generic'
CC [M]  /workspace/difuze/AndroidKernels/ioctldev/dvcfl/dvcfl/dvcfl.o
Building modules, stage 2.
MODPOST 1 modules
CC      /workspace/difuze/AndroidKernels/ioctldev/dvcfl/dvcfl/dvcfl.mod.o
LD [M]  /workspace/difuze/AndroidKernels/ioctldev/dvcfl/dvcfl/dvcfl.ko
make[1]: Leaving directory '/usr/src/linux-headers-4.13.0-43-generic'
$
```
Firstly, an execute user-space program called getdvcfl is generated by gcc. Then, gnu tools build the module dvcfl.ko.

## 2. Usage on x86
Super user is need to insmod the module.
```
su
echo 0 > /proc/sys/kernel/kptr_restrict
insmod dvcfl.ko
exit
```
There will be a file dvcfl in /dev.
```
sudo cat /proc/kallsyms > kallsyms
sudo ./getdvcfl
/dev/char/10:227 mce_chrdev_ioctl
/dev/char/10:231 snapshot_ioctl
/dev/initctl pipe_ioctl
/dev/disk/by-label/DATADRIVE1 block_ioctl
/dev/core proc_reg_unlocked_ioctl
/dev/cuse fuse_dev_ioctl
/dev/bsg/5:0:0:0 bsg_ioctl
/dev/char/29:0 fb_ioctl
/dev/char/5:3 tty_ioctl
/dev/char/1:9 random_ioctl
/dev/char/10:228 hpet_ioctl
/dev/char/10:60 nvm_ctl_ioctl
/dev/char/10:237 loop_control_ioctl
/dev/sg3 sg_ioctl
/dev/char/10:200 tun_chr_ioctl
/dev/char/108:0 ppp_ioctl
/dev/char/189:8 usbdev_ioctl
/dev/char/13:78 evdev_ioctl
/dev/char/10:223 uinput_ioctl
/dev/rtc rtc_dev_ioctl
/dev/i2c-6 i2cdev_ioctl
/dev/char/10:236 dm_ctl_ioctl
/dev/char/10:62 rfkill_fop_ioctl
```
The device names and ioctl function names are listed.

## 3. Usage on Android
If the target device is an Adroid device, the two files should be pushed on device.
```
adb push dvcfl.ko /data/local/tmp
adb push getdvcfl /data/local/tmp
```
Login to the device and swith to super user and load the module
```
adb shell
su
echo 0 > /proc/sys/kernel/kptr_restrict 
cd /data/local/tmp
insmod dvcfl.ko
```
Use getdvcfl to get all devices ioctl infomation.
```
cat /proc/kallsyms > kallsyms
./getdvcfl
```
Wish it be help.
Thanks for visiting.
